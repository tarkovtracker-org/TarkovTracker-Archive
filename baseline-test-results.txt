
> test
> npm run test:functions && npm run test:frontend


> test:functions
> npm run test --workspace=functions


> functions@3.0.0 test
> vitest run


 RUN  v4.0.8 /home/lab/Github/TarkovTracker/functions

 ✓ test/updateTarkovdata-consolidated.test.js (3 tests) 55ms
 ✓ test/middleware/abuseGuard.test.ts (3 tests) 74ms
 ✓ test/team-consolidated.test.js (3 tests) 83ms
 ✓ test/token/create.test.ts (8 tests) 6ms
 ✓ test/token-consolidated.test.js (7 tests) 188ms
 ✓ test/progress/progressUtils.test.ts (2 tests) 5ms
stdout | test/TokenService.test.ts > TokenService > getTokenInfo > should retrieve token information successfully
{"owner":"test-user-123","permissions":["GP","WP"],"severity":"INFO","message":"Token accessed successfully"}

 ✓ test/apiv2.test.js (21 tests) 233ms
 ✓ test/middleware/auth.test.ts (10 tests) 9ms
stderr | test/services/ProgressService.test.ts > ProgressService > throws when essential game data is missing
{"userId":"user-2","hideoutLoaded":false,"tasksLoaded":false,"severity":"ERROR","message":"Error: Failed to load essential Tarkov data\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at ProgressService.getUserProgress (/home/lab/Github/TarkovTracker/functions/src/services/ProgressService.ts:42:16)\n    at /home/lab/Github/TarkovTracker/functions/test/services/ProgressService.test.ts:65:5\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/services/ProgressService.test.ts > ProgressService > updates a single task and handles dependency updates
{"userId":"user-3","taskId":"task-alpha","state":"completed","severity":"INFO","message":"Task updated successfully"}

stdout | test/services/ProgressService.test.ts > ProgressService > swallows dependency errors after updating a task
{"userId":"user-4","taskId":"task-beta","state":"failed","severity":"INFO","message":"Task updated successfully"}

stderr | test/services/ProgressService.test.ts > ProgressService > swallows dependency errors after updating a task
{"error":"dependency failure","userId":"user-4","taskId":"task-beta","state":"failed","severity":"ERROR","message":"Error: Error updating task dependencies:\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at ProgressService.updateSingleTask (/home/lab/Github/TarkovTracker/functions/src/services/ProgressService.ts:136:16)\n    at /home/lab/Github/TarkovTracker/functions/test/services/ProgressService.test.ts:110:5\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

 ✓ test/token-integration.test.js (2 tests) 308ms
     ✓ revokeToken rejects non-POST methods with 405  305ms
 ❯ test/services/ProgressService.test.ts (4 tests | 2 failed) 9ms
     × returns formatted progress data 4ms
     ✓ throws when essential game data is missing 2ms
     × updates a single task and handles dependency updates 1ms
     ✓ swallows dependency errors after updating a task 1ms
 ✓ test/direct-coverage.test.js (5 tests) 321ms
     ✓ token handler returns token info from request  303ms
stdout | test/TokenService.test.ts > TokenService > getTokenInfo > should increment token calls asynchronously
{"owner":"userA","permissions":["GP"],"severity":"INFO","message":"Token accessed successfully"}

stderr | test/token-api.test.js > Token API > Token Creation > should create a token with valid inputs
Could not test token creation: mockCreateTokenLogic is not defined

stderr | test/token-api.test.js > Token API > Token Creation > should reject token creation without auth
Could not test token creation rejection: mockCreateTokenLogic is not defined

stderr | test/token-api.test.js > Token API > Token Creation > should reject token creation without note
Could not test token creation rejection: mockCreateTokenLogic is not defined

stderr | test/token-api.test.js > Token API > Token Revocation > should revoke a token with valid inputs
Could not test token revocation: mockRevokeTokenLogic is not defined

stderr | test/token-api.test.js > Token API > Token Revocation > should reject token revocation without auth
Could not test token revocation rejection: mockRevokeTokenLogic is not defined

stderr | test/token-api.test.js > Token API > Token Revocation > should reject token revocation for non-existent tokens
Could not test token revocation rejection: mockRevokeTokenLogic is not defined

 ✓ test/token-api.test.js (6 tests) 5ms
stdout | test/TokenService.test.ts > TokenService > getTokenInfo > should default gameMode to pvp for legacy tokens
{"owner":"userA","permissions":["GP"],"severity":"INFO","message":"Token accessed successfully"}

stdout | test/TokenService.test.ts > TokenService > getTokenInfo > should handle Firestore errors gracefully
{"owner":"userA","permissions":["GP"],"severity":"INFO","message":"Token accessed successfully"}

stdout | test/TokenService.test.ts > TokenService > validateToken > should validate token from Authorization header
{"owner":"userA","permissions":["GP"],"severity":"INFO","message":"Token accessed successfully"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete user account successfully with valid confirmation
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stdout | test/TokenService.test.ts > TokenService > createToken > should create token successfully
{"owner":"test-user-123","permissions":["GP","WP"],"gameMode":"pvp","note":"Test API token","severity":"INFO","message":"API token created successfully"}

stdout | test/TokenService.test.ts > TokenService > createToken > should generate unique secure tokens
{"owner":"userA","permissions":["GP"],"gameMode":"pvp","note":"Token 1","severity":"INFO","message":"API token created successfully"}

stdout | test/TokenService.test.ts > TokenService > createToken > should generate unique secure tokens
{"owner":"userB","permissions":["WP"],"gameMode":"pve","note":"Token 2","severity":"INFO","message":"API token created successfully"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete user account successfully with valid confirmation
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:85:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/TokenService.test.ts > TokenService > createToken > should trim note whitespace
{"owner":"test-user","permissions":["GP"],"gameMode":"pvp","note":"  Test Token  ","severity":"INFO","message":"API token created successfully"}

stdout | test/TokenService.test.ts > TokenService > createToken > should handle transaction failures
{"owner":"test-user","permissions":["GP"],"gameMode":"pvp","note":"Test token","severity":"INFO","message":"API token created successfully"}

 ✓ test/ValidationService.test.ts (60 tests) 29ms
stdout | test/TokenService.test.ts > TokenService > createToken > should default to pvp game mode when not specified
{"owner":"test-user","permissions":["GP"],"gameMode":"pvp","note":"Test token","severity":"INFO","message":"API token created successfully"}

stdout | test/TokenService.test.ts > TokenService > revokeToken > should revoke token successfully
{"owner":"userA","token":"tokenA...","severity":"INFO","message":"Token revoked successfully"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should throw error for invalid confirmation text
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should throw error for invalid confirmation text
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject unauthenticated requests
{"data":{"note":"Test API token","permissions":["read","write"],"gameMode":"pvp"},"severity":"INFO","message":"Starting create token logic (v2)"}

stderr | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject unauthenticated requests
{"severity":"ERROR","message":"Error: Authentication context missing.\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Proxy.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at _createTokenLogic (/home/lab/Github/TarkovTracker/functions/src/token/create.ts:30:12)\n    at /home/lab/Github/TarkovTracker/functions/test/token-management.test.ts:52:20\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:157:11\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:26\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1636:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1602:10)\n    at runTest (file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1309:12)"}

stdout | test/TokenService.test.ts > TokenService > revokeToken > should handle Firestore errors gracefully
{"owner":"userA","token":"tokenA...","severity":"INFO","message":"Token revoked successfully"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should throw error for missing confirmation text
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle team cleanup when user is not in a team
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject requests with missing note
{"data":{"permissions":["read"]},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stderr | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject requests with missing note
{"data":{"permissions":["read"]},"severity":"WARNING","message":"Invalid token parameters received."}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject requests with missing permissions
{"data":{"note":"Test token"},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stderr | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject requests with missing permissions
{"data":{"note":"Test token"},"severity":"WARNING","message":"Invalid token parameters received."}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle team cleanup when user is not in a team
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:158:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject requests with empty permissions array
{"data":{"note":"Test token","permissions":[]},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stderr | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject requests with empty permissions array
{"data":{"note":"Test token","permissions":[]},"severity":"WARNING","message":"Invalid token parameters received."}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle team member removal when user is not owner
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject invalid gameMode
{"data":{"note":"Test token","permissions":["read"],"gameMode":"invalid"},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stderr | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject invalid gameMode
{"gameMode":"invalid","severity":"WARNING","message":"Invalid gameMode received."}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject when user has maximum tokens (5)
{"data":{"note":"Test API token","permissions":["read","write"],"gameMode":"pvp"},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject when user has maximum tokens (5)
{"owner":"userA","token":"","severity":"INFO","message":"Created token successfully (v2)"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle team member removal when user is not owner
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:214:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should transfer team ownership when user is owner and has other members
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should transfer team ownership when user is owner and has other members
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:295:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete team when user is owner and has no other members
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should create token successfully with valid data
{"data":{"note":"Test API token","permissions":["read","write"],"gameMode":"pvp"},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should create token successfully with valid data
{"owner":"userA","token":"","severity":"INFO","message":"Created token successfully (v2)"}

stdout | test/TokenService.test.ts > TokenService > generateSecureToken > should generate cryptographically secure tokens
{"owner":"userA","permissions":["GP"],"gameMode":"pvp","note":"Token 1","severity":"INFO","message":"API token created successfully"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete team when user is owner and has no other members
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:351:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/TokenService.test.ts > TokenService > generateSecureToken > should generate unique tokens across multiple calls
{"owner":"userA","permissions":["GP"],"gameMode":"pvp","note":"Token 1","severity":"INFO","message":"API token created successfully"}

stdout | test/TokenService.test.ts > TokenService > generateSecureToken > should generate unique tokens across multiple calls
{"owner":"userB","permissions":["WP"],"gameMode":"pve","note":"Token 2","severity":"INFO","message":"API token created successfully"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should create system document if it does not exist
{"data":{"note":"Test API token","permissions":["read","write"],"gameMode":"pvp"},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should create system document if it does not exist
{"owner":"userA","token":"","severity":"INFO","message":"Created token successfully (v2)"}

stdout | test/TokenService.test.ts > TokenService > generateSecureToken > should handle deterministic uniqueness generation with collision
{"owner":"userA","permissions":["GP"],"gameMode":"pvp","note":"Test collision","severity":"INFO","message":"API token created successfully"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete all user tokens
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete all user tokens
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:396:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should handle transaction errors gracefully
{"data":{"note":"Test API token","permissions":["read","write"],"gameMode":"pvp"},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should handle transaction errors gracefully
{"owner":"userA","token":"","severity":"INFO","message":"Created token successfully (v2)"}

stdout | test/TokenService.test.ts > TokenService > integration tests with emulator-backed Firestore operations > token creation with specific scopes > should create token with specific scopes and persist to Firestore
{"owner":"test-user-123","permissions":["GP","WP","TP"],"gameMode":"pve","note":"Test token with specific scopes","severity":"INFO","message":"API token created successfully"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle Firebase Auth user not found error
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should accept valid game modes
{"data":{"note":"Test token","permissions":["read"],"gameMode":"pvp"},"owner":"userA","severity":"INFO","message":"Starting create token logic (v2)"}

stdout | test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should accept valid game modes
{"owner":"userA","token":"","severity":"INFO","message":"Created token successfully (v2)"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle Firebase Auth user not found error
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:444:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/TokenService.test.ts > TokenService > integration tests with emulator-backed Firestore operations > error handling and atomicity > should handle Firestore transaction failures gracefully
{"owner":"test-user-123","permissions":["GP"],"gameMode":"pvp","note":"Test token","severity":"INFO","message":"API token created successfully"}

stderr | test/token-management.test.ts > Token Management > Token Handler (getTokenInfo) > should return 401 when apiToken is missing
{"severity":"WARNING","message":"getTokenInfo called without valid req.apiToken"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle Firestore errors during data deletion
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stderr | test/token-management.test.ts > Token Management > Token Handler (getTokenInfo) > should return 401 when apiToken.token is missing
{"severity":"WARNING","message":"getTokenInfo called without valid req.apiToken"}

stdout | test/TokenService.test.ts > TokenService > integration tests with emulator-backed Firestore operations > error handling and atomicity > should ensure atomic token creation operations
{"owner":"test-user-123","permissions":["GP"],"gameMode":"pvp","note":"Test token","severity":"INFO","message":"API token created successfully"}

stderr | test/token-management.test.ts > Token Management > Token Handler (getTokenInfo) > should handle tokens with empty permissions
{"severity":"WARNING","message":"getTokenInfo called without valid req.apiToken"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle Firestore errors during data deletion
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:458:9\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle errors during team ownership transfer
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

 ❯ test/TokenService.test.ts (39 tests | 10 failed) 57ms
       ✓ should retrieve token information successfully 2ms
       ✓ should throw unauthorized error for non-existent token 2ms
       × should throw internal error when token data is undefined 7ms
       × should increment token calls asynchronously 12ms
       ✓ should default gameMode to pvp for legacy tokens 1ms
       × should handle Firestore errors gracefully 5ms
       ✓ should validate token from Authorization header 1ms
       ✓ should throw error when Authorization header is missing 1ms
       ✓ should throw error for invalid Authorization header format 1ms
       ✓ should throw error for missing token in Bearer format 0ms
       ✓ should throw error for non-Bearer token 0ms
       ✓ should create token successfully 2ms
       ✓ should generate unique secure tokens 1ms
       × should trim note whitespace 1ms
       × should handle transaction failures 1ms
       ✓ should default to pvp game mode when not specified 1ms
       × should revoke token successfully 1ms
       ✓ should throw not found error for non-existent token 0ms
       ✓ should throw forbidden error when user does not own token 1ms
       × should handle Firestore errors gracefully 1ms
       ✓ should list all tokens for a user 1ms
       ✓ should return empty array when user has no tokens 0ms
       ✓ should default gameMode to pvp for legacy tokens 0ms
       × should handle Firestore errors gracefully 3ms
       ✓ should validate valid permissions 0ms
       ✓ should throw error for empty permissions array 0ms
       ✓ should throw error for non-array permissions 0ms
       ✓ should throw error for invalid permissions 0ms
       ✓ should throw error for mixed valid and invalid permissions 0ms
       ✓ should generate cryptographically secure tokens 0ms
       ✓ should generate unique tokens across multiple calls 1ms
       ✓ should handle deterministic uniqueness generation with collision 1ms
         × should create token with specific scopes and persist to Firestore 1ms
         ✓ should validate and reject invalid scope requests 0ms
         ✓ should reject revoked token with proper error code 1ms
         ✓ should handle token validation errors without side effects 2ms
         × should handle Firestore transaction failures gracefully 1ms
         ✓ should ensure atomic token creation operations 1ms
       ✓ rejects revoked token validation 1ms
stderr | test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle errors during team ownership transfer
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:472:9\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle successful user deletion
{"userId":"test-user-123","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle successful user deletion
{"userId":"test-user-123","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at deleteUserAccountHandler (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:274:20)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:502:7\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle successful user deletion
{"error":{"statusCode":500,"code":"INTERNAL_ERROR","name":"ApiError"},"severity":"ERROR","message":"Error: User deletion handler error\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at deleteUserAccountHandler (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:278:12)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:502:7\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

 ❯ test/token-management.test.ts (19 tests | 12 failed) 20ms
       ✓ should reject unauthenticated requests 5ms
       ✓ should reject requests with missing note 1ms
       ✓ should reject requests with missing permissions 0ms
       ✓ should reject requests with empty permissions array 0ms
       ✓ should reject invalid gameMode 1ms
       × should reject when user has maximum tokens (5) 3ms
       × should create token successfully with valid data 1ms
       × should create system document if it does not exist 1ms
       × should handle transaction errors gracefully 1ms
       × should accept valid game modes 1ms
       × should handle missing token in request body 1ms
       ✓ should reject non-POST requests 0ms
       × should revoke token successfully when user owns it 0ms
       × should return 404 when token does not exist 0ms
       × should return 403 when user does not own the token 1ms
       ✓ should return token info when apiToken is present 0ms
       × should return 401 when apiToken is missing 0ms
       × should return 401 when apiToken.token is missing 0ms
       × should handle tokens with empty permissions 0ms
stderr | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should return 401 when user is not authenticated
{"error":{"statusCode":401,"code":"UNAUTHORIZED","name":"ApiError"},"severity":"ERROR","message":"Error: User deletion handler error\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at deleteUserAccountHandler (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:278:12)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:516:13\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:157:11\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:26\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1636:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1602:10)\n    at runTest (file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1309:12)"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle API errors from service
{"userId":"test-user-123","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle API errors from service
{"userId":"test-user-123","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at deleteUserAccountHandler (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:274:20)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:537:7\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle API errors from service
{"error":{"statusCode":500,"code":"INTERNAL_ERROR","name":"ApiError"},"severity":"ERROR","message":"Error: User deletion handler error\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at deleteUserAccountHandler (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:278:12)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:537:7\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle unexpected errors
{"userId":"test-user-123","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle unexpected errors
{"userId":"test-user-123","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at deleteUserAccountHandler (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:274:20)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:558:7\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle unexpected errors
{"error":{"statusCode":500,"code":"INTERNAL_ERROR","name":"ApiError"},"severity":"ERROR","message":"Error: User deletion handler error\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at deleteUserAccountHandler (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:278:12)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:558:7\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle missing user ID
{"error":{"statusCode":401,"code":"UNAUTHORIZED","name":"ApiError"},"severity":"ERROR","message":"Error: User deletion handler error\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at deleteUserAccountHandler (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:278:12)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:574:13\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:157:11\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:26\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1636:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1602:10)\n    at runTest (file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:1309:12)"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > full cascade deletion > should delete user and all associated Firestore documents
{"userId":"victim","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > full cascade deletion > should delete user and all associated Firestore documents
{"userId":"victim","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:658:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > full cascade deletion > should handle team member removal when user is not owner
{"userId":"test-user-member-123","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > full cascade deletion > should handle team member removal when user is not owner
{"userId":"test-user-member-123","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:718:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle Firestore write failures and ensure no partial deletions
{"userId":"test-user-failure-123","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle Firestore write failures and ensure no partial deletions
{"userId":"test-user-failure-123","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:765:9\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle Firebase Auth deletion failure and maintain data integrity
{"userId":"test-user-auth-fail-123","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle Firebase Auth deletion failure and maintain data integrity
{"userId":"test-user-auth-fail-123","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:809:24\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

stdout | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle transaction rollback semantics during team ownership transfer
{"userId":"test-user-rollback-123","severity":"INFO","message":"Starting user deletion process"}

stderr | test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle transaction rollback semantics during team ownership transfer
{"userId":"test-user-rollback-123","error":{},"severity":"ERROR","message":"Error: Error during user deletion\n    at entryFromArgs (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:144:19)\n    at Object.error (/home/lab/Github/TarkovTracker/node_modules/firebase-functions/lib/logger/index.js:131:11)\n    at UserDeletionService.deleteUserAccount (/home/lab/Github/TarkovTracker/functions/src/handlers/userDeletionHandler.ts:74:14)\n    at /home/lab/Github/TarkovTracker/functions/test/userDeletionHandler.test.ts:862:9\n    at file:///home/lab/Github/TarkovTracker/node_modules/@vitest/runner/dist/index.js:753:20"}

 ❯ test/userDeletionHandler.test.ts (23 tests | 16 failed) 53ms
         × should delete user account successfully with valid confirmation 9ms
         ✓ should throw error for invalid confirmation text 3ms
         ✓ should throw error for missing confirmation text 0ms
         × should handle team cleanup when user is not in a team 2ms
         × should handle team member removal when user is not owner 3ms
         × should transfer team ownership when user is owner and has other members 1ms
         × should delete team when user is owner and has no other members 1ms
         × should delete all user tokens 1ms
         × should handle Firebase Auth user not found error 2ms
         ✓ should handle Firestore errors during data deletion 5ms
         ✓ should handle errors during team ownership transfer 1ms
       × should handle successful user deletion 3ms
       ✓ should return 401 when user is not authenticated 1ms
       × should handle API errors from service 2ms
       ✓ should handle unexpected errors 2ms
       ✓ should handle missing user ID 1ms
         × should delete user and all associated Firestore documents 2ms
         × should handle team member removal when user is not owner 2ms
         × should handle Firestore write failures and ensure no partial deletions 4ms
         × should handle Firebase Auth deletion failure and maintain data integrity 1ms
         × should handle transaction rollback semantics during team ownership transfer 2ms
       × deletes user and cascades cleanup atomically 1ms
       × rolls back on failure with no partial deletions 1ms
 ✓ test/apiv2-integration.test.js (5 tests) 403ms
       ✓ attaches token info and calls next on success  320ms
 ✓ test/scheduled/index.test.js (3 tests) 1583ms
       ✓ should handle item fetch failure gracefully  1503ms

⎯⎯⎯⎯⎯⎯ Failed Tests 40 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  test/TokenService.test.ts > TokenService > getTokenInfo > should throw internal error when token data is undefined
AssertionError: expected [Function] to throw error including 'Invalid token data' but got 'Invalid or expired token'

Expected: "Invalid token data"
Received: "Invalid or expired token"

 ❯ test/TokenService.test.ts:120:7
    118| 
    119|       const tokenService = new TokenService();
    120|       await expect(tokenService.getTokenInfo('test-token')).rejects.to…
       |       ^
    121|     });
    122| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > getTokenInfo > should increment token calls asynchronously
AssertionError: expected undefined to be defined
 ❯ test/TokenService.test.ts:136:29
    134|       const docCalls = collectionMock.doc.mock.calls;
    135|       const incrementCall = docCalls.find(call => call[0] === 'tokenA'…
    136|       expect(incrementCall).toBeDefined();
       |                             ^
    137|       
    138|       // Find the doc reference that was used for the update

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > getTokenInfo > should handle Firestore errors gracefully
AssertionError: promise resolved "{ owner: 'userA', …(6) }" instead of rejecting

- Expected
+ Received

- Error {
-   "message": "rejected promise",
+ {
+   "calls": 5,
+   "createdAt": {
+     "toDate": [Function toDate],
+   },
+   "gameMode": "pvp",
+   "note": "Test token A",
+   "owner": "userA",
+   "permissions": [
+     "GP",
+   ],
+   "token": "tokenA",
  }

 ❯ test/TokenService.test.ts:191:55
    189| 
    190|       const tokenService = new TokenService();
    191|       await expect(tokenService.getTokenInfo('tokenA')).rejects.toThro…
       |                                                       ^
    192|         'Failed to retrieve token information'
    193|       );

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > createToken > should trim note whitespace
AssertionError: expected "vi.fn()" to be called at least once
 ❯ test/TokenService.test.ts:312:44
    310| 
    311|       // Verify the transaction was called
    312|       expect(firestoreMock.runTransaction).toHaveBeenCalled();
       |                                            ^
    313|     });
    314| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > createToken > should handle transaction failures
AssertionError: promise resolved "{ …(2) }" instead of rejecting

- Expected
+ Received

- Error {
-   "message": "rejected promise",
+ {
+   "created": true,
+   "token": "o68kqdf5Ken7RT4Ve2eOvSvIj4dHTA8QHdfGIDAIKNoCa6Yih06dQQf5wf0PZe5X",
  }

 ❯ test/TokenService.test.ts:324:7
    322|       await expect(
    323|         tokenService.createToken('test-user', 'Test token', ['GP'], 'p…
    324|       ).rejects.toThrow(/failed to create token/i);
       |       ^
    325|     });
    326| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > revokeToken > should revoke token successfully
AssertionError: expected "vi.fn()" to be called with arguments: [ 'tokenA' ]

Number of calls: 0

 ❯ test/TokenService.test.ts:351:34
    349|       // The delete method should have been called on the token docume…
    350|       const collectionMock = firestoreMock.collection('token');
    351|       expect(collectionMock.doc).toHaveBeenCalledWith('tokenA');
       |                                  ^
    352|       const usedDocRef = collectionMock.doc.mock.results[0].value;
    353|       expect(usedDocRef.delete).toHaveBeenCalled();

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > revokeToken > should handle Firestore errors gracefully
AssertionError: promise resolved "{ revoked: true }" instead of rejecting

- Expected
+ Received

- Error {
-   "message": "rejected promise",
+ {
+   "revoked": true,
  }

 ❯ test/TokenService.test.ts:410:63
    408| 
    409|       const tokenService = new TokenService();
    410|       await expect(tokenService.revokeToken('tokenA', 'userA')).reject…
       |                                                               ^
    411|         'Failed to revoke token'
    412|       );

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > listUserTokens > should handle Firestore errors gracefully
AssertionError: promise resolved "[ { owner: 'userA', …(5) }, …(1) ]" instead of rejecting

- Expected: 
Error {
  "message": "rejected promise",
}

+ Received: 
[
  {
    "calls": 5,
    "createdAt": {
      "toDate": [Function toDate],
    },
    "gameMode": "pvp",
    "note": "Test token A",
    "owner": "userA",
    "permissions": [
      "GP",
    ],
  },
  {
    "calls": 10,
    "createdAt": {
      "toDate": [Function toDate],
    },
    "gameMode": "pvp",
    "note": "Test token B",
    "owner": "userA",
    "permissions": [
      "GP",
      "WP",
    ],
  },
]

 ❯ test/TokenService.test.ts:503:56
    501| 
    502|       const tokenService = new TokenService();
    503|       await expect(tokenService.listUserTokens('userA')).rejects.toThr…
       |                                                        ^
    504|     });
    505|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > integration tests with emulator-backed Firestore operations > token creation with specific scopes > should create token with specific scopes and persist to Firestore
TypeError: .toMatch() expects to receive a string, but got object
 ❯ test/TokenService.test.ts:670:24
    668|         );
    669| 
    670|         expect(result).toMatch(/^[a-zA-Z0-9]{64,}$/);
       |                        ^
    671|         expect(firestoreMock.runTransaction).toHaveBeenCalled();
    672|       });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/40]⎯

 FAIL  test/TokenService.test.ts > TokenService > integration tests with emulator-backed Firestore operations > error handling and atomicity > should handle Firestore transaction failures gracefully
AssertionError: promise resolved "{ …(2) }" instead of rejecting

- Expected
+ Received

- Error {
-   "message": "rejected promise",
+ {
+   "created": true,
+   "token": "9fpYsUpcCCSGCwK6cqERAHkH0KX23WxjrRA8HHKok1O7VX3NgnW6mNAQBVKfRfPb",
  }

 ❯ test/TokenService.test.ts:753:9
    751|         await expect(
    752|           tokenService.createToken('test-user-123', 'Test token', ['GP…
    753|         ).rejects.toThrow('Failed to create token');
       |         ^
    754|       });
    755| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should reject when user has maximum tokens (5)
AssertionError: promise resolved "{ token: '' }" instead of rejecting

- Expected
+ Received

- Error {
-   "message": "rejected promise",
+ {
+   "token": "",
  }

 ❯ test/token-management.test.ts:107:53
    105|       });
    106| 
    107|       await expect(_createTokenLogic(request as any)).rejects.toThrow(
       |                                                     ^
    108|         'You have the maximum number of tokens (5).'
    109|       );

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should create token successfully with valid data
AssertionError: expected '' to be 'uuid-1' // Object.is equality

- Expected
+ Received

- uuid-1

 ❯ test/token-management.test.ts:130:28
    128| 
    129|       expect(result).toHaveProperty('token');
    130|       expect(result.token).toBe('uuid-1'); // From setup.js determinis…
       |                            ^
    131|     });
    132| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should create system document if it does not exist
AssertionError: expected '' to be 'uuid-1' // Object.is equality

- Expected
+ Received

- uuid-1

 ❯ test/token-management.test.ts:151:28
    149| 
    150|       expect(result).toHaveProperty('token');
    151|       expect(result.token).toBe('uuid-1'); // From setup.js determinis…
       |                            ^
    152|     });
    153| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[13/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should handle transaction errors gracefully
AssertionError: promise resolved "{ token: '' }" instead of rejecting

- Expected
+ Received

- Error {
-   "message": "rejected promise",
+ {
+   "token": "",
  }

 ❯ test/token-management.test.ts:159:53
    157|       firestoreMock.runTransaction.mockRejectedValueOnce(new Error('Tr…
    158| 
    159|       await expect(_createTokenLogic(request as any)).rejects.toThrow(
       |                                                     ^
    160|         'An unexpected error occurred during token creation.'
    161|       );

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[14/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Creation (_createTokenLogic) > should accept valid game modes
AssertionError: expected '' to be 'uuid-1' // Object.is equality

- Expected
+ Received

- uuid-1

 ❯ test/token-management.test.ts:185:30
    183| 
    184|         const result = await _createTokenLogic(request as any);
    185|         expect(result.token).toBe('uuid-1'); // From setup.js determin…
       |                              ^
    186|       }
    187|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[15/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Revocation (revokeToken) > should handle missing token in request body
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 ❯ test/token-management.test.ts:211:14
    209|       await revokeToken(req as any, res as any);
    210| 
    211|       const [[statusCode]] = res.status.mock.calls;
       |              ^
    212|       const [[payload]] = res.json.mock.calls;
    213|       expect(statusCode).toBe(400);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[16/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Revocation (revokeToken) > should revoke token successfully when user owns it
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 ❯ test/token-management.test.ts:256:14
    254|       await revokeToken(req as any, res as any);
    255| 
    256|       const [[statusCode]] = res.status.mock.calls;
       |              ^
    257|       const [[body]] = res.json.mock.calls;
    258|       expect(statusCode).toBe(200);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[17/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Revocation (revokeToken) > should return 404 when token does not exist
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 ❯ test/token-management.test.ts:280:14
    278|       await revokeToken(req as any, res as any);
    279| 
    280|       const [[statusCode]] = res.status.mock.calls;
       |              ^
    281|       const [[body]] = res.json.mock.calls;
    282|       expect(statusCode).toBe(404);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[18/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Revocation (revokeToken) > should return 403 when user does not own the token
AssertionError: expected "vi.fn()" to be called with arguments: [ 403 ]

Number of calls: 0

 ❯ test/token-management.test.ts:304:26
    302|       await revokeToken(req as any, res as any);
    303| 
    304|       expect(res.status).toHaveBeenCalledWith(403);
       |                          ^
    305|       const [body] = res.json.mock.calls.at(-1) || [];
    306|       expect(body).toEqual(expect.objectContaining({ error: expect.any…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[19/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Handler (getTokenInfo) > should return 401 when apiToken is missing
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 ❯ test/token-management.test.ts:347:14
    345| 
    346|       const [[statusCode]] = res.status.mock.calls;
    347|       const [[payload]] = res.json.mock.calls;
       |              ^
    348|       expect(statusCode).toBe(401);
    349|       expect(payload).toEqual({ error: 'Unauthorized' });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[20/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Handler (getTokenInfo) > should return 401 when apiToken.token is missing
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 ❯ test/token-management.test.ts:359:14
    357| 
    358|       const [[statusCode]] = res.status.mock.calls;
    359|       const [[payload]] = res.json.mock.calls;
       |              ^
    360|       expect(statusCode).toBe(401);
    361|       expect(payload).toEqual({ error: 'Unauthorized' });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[21/40]⎯

 FAIL  test/token-management.test.ts > Token Management > Token Handler (getTokenInfo) > should handle tokens with empty permissions
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 ❯ test/token-management.test.ts:371:14
    369| 
    370|       const [[statusCode]] = res.status.mock.calls;
    371|       const [[payload]] = res.json.mock.calls;
       |              ^
    372|       expect(statusCode).toBe(200);
    373|       expect(payload).toEqual({

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[22/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete user account successfully with valid confirmation
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:85:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[23/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle team cleanup when user is not in a team
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:158:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[24/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle team member removal when user is not owner
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:214:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[25/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should transfer team ownership when user is owner and has other members
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:295:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[26/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete team when user is owner and has no other members
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:351:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[27/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should delete all user tokens
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:396:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[28/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > UserDeletionService > deleteUserAccount > should handle Firebase Auth user not found error
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:444:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[29/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle successful user deletion
AssertionError: expected "vi.fn()" to be called with arguments: [ 200 ]

Received: 

  1st vi.fn() call:

  [
-   200,
+   500,
  ]


Number of calls: 1

 ❯ test/userDeletionHandler.test.ts:504:26
    502|       await deleteUserAccountHandler(req as any, res as any);
    503| 
    504|       expect(res.status).toHaveBeenCalledWith(200);
       |                          ^
    505|       const [body] = res.json.mock.calls.at(-1) || [];
    506|       expect(body).toEqual(expect.objectContaining({

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[30/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > deleteUserAccountHandler > should handle API errors from service
AssertionError: expected 500 to be 400 // Object.is equality

- Expected
+ Received

- 400
+ 500

 ❯ test/userDeletionHandler.test.ts:541:26
    539|       const [[statusCode]] = res.status.mock.calls;
    540|       const [[body]] = res.json.mock.calls;
    541|       expect(statusCode).toBe(400);
       |                          ^
    542|       expect(body).toEqual(expect.objectContaining({
    543|         success: false,

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[31/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > full cascade deletion > should delete user and all associated Firestore documents
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:658:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[32/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > full cascade deletion > should handle team member removal when user is not owner
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:718:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[33/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle Firestore write failures and ensure no partial deletions
AssertionError: expected [Function] to throw error including 'Firestore write failed' but got 'Failed to delete user account. Please…'

Expected: "Firestore write failed"
Received: "Failed to delete user account. Please try again later."

 ❯ test/userDeletionHandler.test.ts:765:9
    763|         const userDeletionService = new UserDeletionService();
    764|         
    765|         await expect(
       |         ^
    766|           userDeletionService.deleteUserAccount(userId, request)
    767|         ).rejects.toThrow('Firestore write failed');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[34/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle Firebase Auth deletion failure and maintain data integrity
ApiError: Failed to delete user account. Please try again later.
 ❯ createError src/middleware/errorHandler.ts:110:10
    108|  */
    109| export const createError = (statusCode: number, message: string, code?…
    110|   return new ApiError(statusCode, message, code);
       |          ^
    111| };
    112| 
 ❯ Object.internal src/middleware/errorHandler.ts:123:5
 ❯ UserDeletionService.deleteUserAccount src/handlers/userDeletionHandler.ts:80:20
 ❯ test/userDeletionHandler.test.ts:809:24

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[35/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > integration tests with emulator-backed cascade deletion > failure path with atomicity > should handle transaction rollback semantics during team ownership transfer
AssertionError: expected [Function] to throw error including 'Transaction failed' but got 'Failed to delete user account. Please…'

Expected: "Transaction failed"
Received: "Failed to delete user account. Please try again later."

 ❯ test/userDeletionHandler.test.ts:862:9
    860|         const userDeletionService = new UserDeletionService();
    861|         
    862|         await expect(
       |         ^
    863|           userDeletionService.deleteUserAccount(userId, request)
    864|         ).rejects.toThrow('Transaction failed');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[36/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > userDeletionHandler > deletes user and cascades cleanup atomically
ReferenceError: userDeletionHandler is not defined
 ❯ test/userDeletionHandler.test.ts:877:7
    875|       const res = makeRes();
    876|       const req = { params: { uid: 'uid1' } } as any;
    877|       await userDeletionHandler(req, res);
       |       ^
    878|       expect(res.status).toHaveBeenCalledWith(200);
    879|       // Verify cascade cleanup via collection.get() snapshots

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[37/40]⎯

 FAIL  test/userDeletionHandler.test.ts > User Deletion Handler > userDeletionHandler > rolls back on failure with no partial deletions
ReferenceError: userDeletionHandler is not defined
 ❯ test/userDeletionHandler.test.ts:893:7
    891|       const res = makeRes();
    892|       const req = { params: { uid: 'missing' } } as any;
    893|       await userDeletionHandler(req, res);
       |       ^
    894|       expect(res.status).toHaveBeenCalledWith(500);
    895|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[38/40]⎯

 FAIL  test/services/ProgressService.test.ts > ProgressService > returns formatted progress data
AssertionError: expected "vi.fn()" to be called with arguments: [ 'user-1' ]

Number of calls: 0

 ❯ test/services/ProgressService.test.ts:47:28
     45|     const result = await service.getUserProgress('user-1', 'pvp');
     46| 
     47|     expect(collection.doc).toHaveBeenCalledWith('user-1');
       |                            ^
     48|     expect(formatProgress).toHaveBeenCalledWith(
     49|       { currentGameMode: 'pvp', legacy: true },

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39/40]⎯

 FAIL  test/services/ProgressService.test.ts > ProgressService > updates a single task and handles dependency updates
AssertionError: expected "vi.fn()" to be called 1 times, but got 0 times
 ❯ test/services/ProgressService.test.ts:87:42
     85|     await service.updateSingleTask('user-3', 'task-alpha', 'completed'…
     86| 
     87|     expect(firestoreMock.runTransaction).toHaveBeenCalledTimes(1);
       |                                          ^
     88|     expect(transactionUpdate).toHaveBeenCalledWith(
     89|       expect.objectContaining({ path: expect.stringContaining('progres…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[40/40]⎯

⎯⎯⎯⎯⎯⎯ Unhandled Errors ⎯⎯⎯⎯⎯⎯

Vitest caught 4 unhandled errors during the test run.
This might cause false positive tests. Resolve unhandled errors to make sure your tests are not affected.

⎯⎯⎯⎯ Unhandled Rejection ⎯⎯⎯⎯⎯
TypeError: Cannot read properties of undefined (reading 'origin')
 ❯ setCorsHeaders src/config/corsConfig.ts:134:30
    132| }
    133| export function setCorsHeaders(req: CorsRequest, res: CorsResponse): b…
    134|   const origin = req.headers.origin;
       |                              ^
    135|   const validatedOrigin = validateOrigin(origin, {
    136|     trustNoOrigin: true,
 ❯ withCorsAndAuth src/middleware/onRequestAuth.ts:29:8
 ❯ src/token/revoke.ts:156:5
 ❯ ../node_modules/firebase-functions/lib/common/onInit.js:33:16
 ❯ ../node_modules/firebase-functions/lib/v2/trace.js:16:28
 ❯ test/token-management.test.ts:209:13
 ❯ ../node_modules/@vitest/runner/dist/index.js:157:11
 ❯ ../node_modules/@vitest/runner/dist/index.js:753:26
 ❯ ../node_modules/@vitest/runner/dist/index.js:1636:20

This error originated in "test/token-management.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.

⎯⎯⎯⎯ Unhandled Rejection ⎯⎯⎯⎯⎯
TypeError: Cannot read properties of undefined (reading 'origin')
 ❯ setCorsHeaders src/config/corsConfig.ts:134:30
    132| }
    133| export function setCorsHeaders(req: CorsRequest, res: CorsResponse): b…
    134|   const origin = req.headers.origin;
       |                              ^
    135|   const validatedOrigin = validateOrigin(origin, {
    136|     trustNoOrigin: true,
 ❯ withCorsAndAuth src/middleware/onRequestAuth.ts:29:8
 ❯ src/token/revoke.ts:156:5
 ❯ ../node_modules/firebase-functions/lib/common/onInit.js:33:16
 ❯ ../node_modules/firebase-functions/lib/v2/trace.js:16:28
 ❯ test/token-management.test.ts:254:13
 ❯ ../node_modules/@vitest/runner/dist/index.js:157:11
 ❯ ../node_modules/@vitest/runner/dist/index.js:753:26
 ❯ ../node_modules/@vitest/runner/dist/index.js:1636:20

This error originated in "test/token-management.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.

⎯⎯⎯⎯ Unhandled Rejection ⎯⎯⎯⎯⎯
TypeError: Cannot read properties of undefined (reading 'origin')
 ❯ setCorsHeaders src/config/corsConfig.ts:134:30
    132| }
    133| export function setCorsHeaders(req: CorsRequest, res: CorsResponse): b…
    134|   const origin = req.headers.origin;
       |                              ^
    135|   const validatedOrigin = validateOrigin(origin, {
    136|     trustNoOrigin: true,
 ❯ withCorsAndAuth src/middleware/onRequestAuth.ts:29:8
 ❯ src/token/revoke.ts:156:5
 ❯ ../node_modules/firebase-functions/lib/common/onInit.js:33:16
 ❯ ../node_modules/firebase-functions/lib/v2/trace.js:16:28
 ❯ test/token-management.test.ts:278:13
 ❯ ../node_modules/@vitest/runner/dist/index.js:157:11
 ❯ ../node_modules/@vitest/runner/dist/index.js:753:26
 ❯ ../node_modules/@vitest/runner/dist/index.js:1636:20

This error originated in "test/token-management.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.

⎯⎯⎯⎯ Unhandled Rejection ⎯⎯⎯⎯⎯
TypeError: Cannot read properties of undefined (reading 'origin')
 ❯ setCorsHeaders src/config/corsConfig.ts:134:30
    132| }
    133| export function setCorsHeaders(req: CorsRequest, res: CorsResponse): b…
    134|   const origin = req.headers.origin;
       |                              ^
    135|   const validatedOrigin = validateOrigin(origin, {
    136|     trustNoOrigin: true,
 ❯ withCorsAndAuth src/middleware/onRequestAuth.ts:29:8
 ❯ src/token/revoke.ts:156:5
 ❯ ../node_modules/firebase-functions/lib/common/onInit.js:33:16
 ❯ ../node_modules/firebase-functions/lib/v2/trace.js:16:28
 ❯ test/token-management.test.ts:302:13
 ❯ ../node_modules/@vitest/runner/dist/index.js:157:11
 ❯ ../node_modules/@vitest/runner/dist/index.js:753:26
 ❯ ../node_modules/@vitest/runner/dist/index.js:1636:20

This error originated in "test/token-management.test.ts" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯


 Test Files  4 failed | 14 passed (18)
      Tests  40 failed | 183 passed (223)
     Errors  4 errors
   Start at  10:11:45
   Duration  2.01s (transform 2.75s, setup 1.18s, collect 3.93s, tests 3.44s, environment 1ms, prepare 161ms)

npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /home/lab/Github/TarkovTracker/functions
npm error workspace functions@3.0.0
npm error location /home/lab/Github/TarkovTracker/functions
npm error command failed
npm error command sh -c vitest run
